<!-- templates/index.html -->
<html>
<head>
  <script src="https://unpkg.com/htmx.org@1.9.5"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto mt-10 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row">
    <div class="md:w-1/2 border-b md:border-b-0 md:border-r border-gray-200 p-8 flex flex-col">
      <h3 class="text-2xl font-bold mb-6 text-blue-600">Chat</h3>
      <form id="chat-form" class="flex gap-2 mb-4">
        <input id="message-input" name="message" autocomplete="off"
          class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
          placeholder="Chat with agent and watch it work..." />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">Send</button>
      </form>
      <div id="chat-log" class="flex-1 space-y-2 overflow-y-auto"></div>
    </div>
    <div class="md:w-1/2 p-8 flex flex-col">
      <h3 class="text-2xl font-bold mb-6 text-green-600">Todos</h3>
      <form 
        hx-post="/add" 
        hx-target="#todo-items" 
        hx-swap="innerHTML"
        hx-on::after-request="this.reset()"
        class="flex gap-2 mb-6"
      >
        <input name="task" required class="flex-1 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Add a new todo..." />
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">Add</button>
      </form>
      <div id="todo-list">
        {% include "partials/todo_items.html" %}
      </div>
    </div>
  </div>
</body>
</html>

<script>
  // This script remains to refresh the todo list when it's updated via its own form.
  document.body.addEventListener('htmx:afterRequest', function(evt) {
    const taskForm = evt.target.closest('form[hx-post^="/add"], form[hx-post^="/edit"], form[hx-post^="/delete"]');
    if (taskForm) {
      htmx.ajax("GET", "/partial/todos", "#todo-list");
    }
  });

  // New script to handle chat form submission and streaming
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const chatLog = document.getElementById('chat-log');

  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const message = messageInput.value;
    if (!message) return;

    // Display user's message
    const userMessageDiv = document.createElement('div');
    userMessageDiv.innerHTML = `<b>You:</b> ${message}`;
    chatLog.appendChild(userMessageDiv);

    // Create container for agent's streaming response
    const agentMessageDiv = document.createElement('div');
    agentMessageDiv.innerHTML = '<b>Agent:</b> <span class="agent-response"></span>';
    chatLog.appendChild(agentMessageDiv);
    const agentResponseSpan = agentMessageDiv.querySelector('.agent-response');

    // Reset input
    messageInput.value = '';

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `message=${encodeURIComponent(message)}`
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) {
          // After stream is complete, refresh the todo list
          htmx.ajax("GET", "/partial/todos", { target: document.getElementById('todo-list'), swap: 'outerHTML' });
          break;
        }
        agentResponseSpan.textContent += decoder.decode(value, { stream: true });
      }
    } catch (error) {
      agentResponseSpan.textContent = 'Error fetching response.';
      console.error('Streaming error:', error);
    }
  });
</script>
